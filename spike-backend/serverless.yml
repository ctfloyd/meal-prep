service: spike-backend
# Create an optimized package for our functions
package:
  individually: true
plugins:
  - serverless-functions-base-path
  - serverless-offline
  - serverless-dynamodb-local
  - serverless-bundle # Package our functions with Webpack
  - serverless-dotenv-plugin # Load .env as environment variables
custom:
    functionsBasePath: src/handlers
    tableNames:
      authTable: 'auth'
    endpoints:
      dynamodb-url: 'http://localhost:8001'
    dynamodb:
      start:
        migrate: true
        port: 8001
      stages:
        - dev
provider:
  name: aws
  runtime: nodejs12.x
  stage: dev
  region: us-east-1
  # These environment variables are made available to our functions
  # under process.env.
  environment:
    authTable: auth
    CONFIG_AUTH_TABLE: ${self:custom.tableNames.authTable}
    CONFIG_DYNAMODB_ENDPOINT: ${self:custom.endpoints.dynamodb-url}
  # 'iamRoleStatements' defines the permission policy for the Lambda function.
  # In this case Lambda functions are granted with permissions to access DynamoDB.
  iamRoleStatements:
    - Effect: Allow
      Action:
        - dynamodb:DescribeTable
        - dynamodb:Query
        - dynamodb:Scan
        - dynamodb:GetItem
        - dynamodb:PutItem
        - dynamodb:UpdateItem
        - dynamodb:DeleteItem
      Resource: "arn:aws:dynamodb:us-east-1:*:table/*"
resources:
  Resources: 
    authTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: auth
        AttributeDefinitions:
          - AttributeName: userId
            AttributeType: S
        KeySchema:
          - AttributeName: userId
            KeyType: HASH
        ProvisionedThroughput:
          ReadCapacityUnits: 1
          WriteCapacityUnits: 1
functions:
# Defines an HTTP API endpoint that calls the main function in create.js
# - path: url path is /notes
# - method: POST request
# - cors: enabled CORS (Cross-Origin Resource Sharing) for browser cross
# domain api call
# - authorizer: authenticate using the AWS IAM role
  create:
    handler: create.main
    events:
      - http:
        path: createUser
        method: post
        cors: true
        authorizer: aws_iam
